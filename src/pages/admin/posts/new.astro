---
// Admin New Post Editor v2 - Con Editor Visual WYSIWYG
import BaseLayout from '../../../layouts/BaseLayout.astro';

const title = 'Nuevo Post | Equitracción CMS';
---

<BaseLayout title={title} mode="hybrid">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-4xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <a href="/admin/posts" class="text-gray-600 hover:text-gray-900">← Volver</a>
            <div>
              <h1 class="font-heading font-bold text-2xl text-gray-900">Nuevo Post</h1>
              <p class="text-base text-gray-600">Crea un nuevo artículo para el blog</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="save-draft-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-gray-700 text-base">
              Guardar Borrador
            </button>
            <button id="publish-btn" class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium text-base">
              Publicar
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-6 py-8">
      <div class="space-y-6">
        <!-- Basic Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <h2 class="font-heading font-bold text-lg mb-4">Información Básica</h2>

          <div class="space-y-4">
            <!-- Title -->
            <div>
              <label for="title" class="block text-base font-medium text-gray-700 mb-2">
                Título del Post *
              </label>
              <input
                type="text"
                id="title"
                required
                placeholder="Ej: Beneficios de la Tracción Equina en Bosques"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 focus:border-transparent text-base"
              />
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <!-- Category -->
              <div>
                <label for="category" class="block text-base font-medium text-gray-700 mb-2">
                  Categoría *
                </label>
                <select
                  id="category"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 text-base"
                >
                  <option value="">Seleccionar...</option>
                  <option value="forestales">Silvicultura (Empresas)</option>
                  <option value="desarrollo">Desarrollo Personal</option>
                  <option value="formacion">Formación</option>
                  <option value="fundacion">Fundación</option>
                </select>
              </div>

              <!-- Author -->
              <div>
                <label for="author" class="block text-base font-medium text-gray-700 mb-2">
                  Autor *
                </label>
                <input
                  type="text"
                  id="author"
                  required
                  value="Roberto Contaldo"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 text-base"
                />
              </div>
            </div>

            <!-- Excerpt -->
            <div>
              <label for="excerpt" class="block text-base font-medium text-gray-700 mb-2">
                Resumen del Post *
              </label>
              <textarea
                id="excerpt"
                required
                rows="3"
                placeholder="Escribe un breve resumen de 2-3 frases"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 resize-none text-base"
              ></textarea>
            </div>

            <!-- Tags -->
            <div>
              <label for="tags" class="block text-base font-medium text-gray-700 mb-2">
                Etiquetas (separadas por comas)
              </label>
              <input
                type="text"
                id="tags"
                placeholder="Ej: tracción equina, sostenibilidad, gestión forestal"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 text-base"
              />
            </div>
          </div>
        </div>

        <!-- Cover Image -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <h2 class="font-heading font-bold text-lg mb-4">Imagen de Portada</h2>

          <div id="cover-upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-amber-800 transition-colors cursor-pointer">
            <input type="file" id="cover-image-input" accept="image/*" class="hidden" />
            <div id="cover-upload-prompt">
              <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p class="text-base font-medium text-gray-900 mb-2">Haz click o arrastra una imagen aquí</p>
              <p class="text-base text-gray-500">JPG, PNG o WebP • Máximo 5MB</p>
            </div>
            <div id="cover-preview" class="hidden">
              <img id="cover-preview-img" class="max-w-full max-h-64 mx-auto rounded-lg shadow-lg mb-4" />
              <button type="button" id="remove-cover" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-base">
                Eliminar Imagen
              </button>
            </div>
          </div>
          <input type="hidden" id="cover_image" />
        </div>

        <!-- Content Editor with Quill.js -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <h2 class="font-heading font-bold text-lg mb-4">Contenido del Post</h2>

          <!-- Quill Editor Container -->
          <div id="editor-container" class="bg-white">
            <div id="editor" style="min-height: 500px;"></div>
          </div>

          <input type="hidden" id="content" />

          <p class="text-base text-gray-500 mt-4">
            <strong>Consejo:</strong> Usa la barra de herramientas para dar formato al texto. El editor funciona como Word.
          </p>
        </div>
      </div>
    </main>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-800 mx-auto mb-4"></div>
      <p class="text-gray-900 font-medium text-base">Guardando post...</p>
    </div>
  </div>
</BaseLayout>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
  import { createClient } from '@supabase/supabase-js';

  // Create Supabase client with public env vars
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  // Initialize Quill editor
  let quill: any;

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', () => {
    quill = new (window as any).Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['blockquote', 'link', 'image'],
          ['clean']
        ]
      },
      placeholder: 'Empieza a escribir aquí tu contenido...'
    });
  });

  // Check authentication
  const checkAuth = () => {
    const isAuthenticated = sessionStorage.getItem('admin_authenticated');
    if (!isAuthenticated) {
      window.location.href = '/admin/login';
    }
  };

  // Generate slug from title
  const generateSlug = (title: string): string => {
    return title
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '');
  };

  // Cover image upload
  const coverUploadArea = document.getElementById('cover-upload-area')!;
  const coverImageInput = document.getElementById('cover-image-input') as HTMLInputElement;
  const coverPreview = document.getElementById('cover-preview')!;
  const coverPreviewImg = document.getElementById('cover-preview-img') as HTMLImageElement;
  const coverUploadPrompt = document.getElementById('cover-upload-prompt')!;
  const removeCoverBtn = document.getElementById('remove-cover')!;
  const coverImageField = document.getElementById('cover_image') as HTMLInputElement;

  coverUploadArea.addEventListener('click', () => {
    if (coverPreview.classList.contains('hidden')) {
      coverImageInput.click();
    }
  });

  coverUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    coverUploadArea.classList.add('border-[rgb(var(--color-brand-primary))]');
  });

  coverUploadArea.addEventListener('dragleave', () => {
    coverUploadArea.classList.remove('border-[rgb(var(--color-brand-primary))]');
  });

  coverUploadArea.addEventListener('drop', async (e) => {
    e.preventDefault();
    coverUploadArea.classList.remove('border-[rgb(var(--color-brand-primary))]');

    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      await uploadCoverImage(files[0]);
    }
  });

  coverImageInput.addEventListener('change', async (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (files && files.length > 0) {
      await uploadCoverImage(files[0]);
    }
  });

  removeCoverBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    coverPreview.classList.add('hidden');
    coverUploadPrompt.classList.remove('hidden');
    coverImageField.value = '';
    coverImageInput.value = '';
  });

  const uploadCoverImage = async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (!response.ok) {
        alert(result.error || 'Error al subir la imagen');
        return;
      }

      coverImageField.value = result.url;
      coverPreviewImg.src = result.url;
      coverUploadPrompt.classList.add('hidden');
      coverPreview.classList.remove('hidden');
    } catch (error) {
      console.error('Error uploading cover image:', error);
      alert('Error al subir la imagen');
    }
  };

  // Quill handles all formatting internally - no custom code needed

  // Save post
  const savePost = async (published: boolean) => {
    const title = (document.getElementById('title') as HTMLInputElement).value.trim();
    const category = (document.getElementById('category') as HTMLSelectElement).value;
    const author = (document.getElementById('author') as HTMLInputElement).value.trim();
    const excerpt = (document.getElementById('excerpt') as HTMLTextAreaElement).value.trim();
    const tagsInput = (document.getElementById('tags') as HTMLInputElement).value.trim();
    const coverImage = (document.getElementById('cover_image') as HTMLInputElement).value.trim();

    // Get content from Quill editor as HTML
    const content = quill.root.innerHTML;

    // Validation
    if (!title || !category || !author || !excerpt) {
      alert('Por favor completa todos los campos obligatorios (*)');
      return;
    }

    // Check if Quill is empty (only whitespace)
    if (!quill || quill.getText().trim().length === 0) {
      alert('El contenido del post no puede estar vacío');
      return;
    }

    // Parse tags
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

    // Generate slug
    const slug = generateSlug(title);

    // Calculate reading time (extract text from HTML for word count)
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    const wordCount = textContent.split(/\s+/).filter(w => w.length > 0).length;
    const readingTime = Math.ceil(wordCount / 200);

    document.getElementById('loading-modal')!.classList.remove('hidden');

    try {
      const response = await fetch('/api/posts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          slug,
          excerpt,
          content,
          category,
          author,
          tags,
          cover_image: coverImage || null,
          reading_time: readingTime,
          published,
          published_at: published ? new Date().toISOString() : null
        })
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Error al guardar');
      }

      alert(published ? '¡Post publicado con éxito!' : '¡Borrador guardado con éxito!');
      window.location.href = '/admin/posts';
    } catch (error: any) {
      console.error('Error saving post:', error);
      if (error.message?.includes('slug') || error.message?.includes('título')) {
        alert('Ya existe un post con ese título. Por favor usa uno diferente.');
      } else {
        alert('Error al guardar el post: ' + error.message);
      }
    } finally {
      document.getElementById('loading-modal')!.classList.add('hidden');
    }
  };

  // Event listeners
  document.getElementById('save-draft-btn')?.addEventListener('click', () => savePost(false));
  document.getElementById('publish-btn')?.addEventListener('click', () => savePost(true));

  // Initialize
  checkAuth();
</script>

<style>
  /* Quill editor custom styles */
  .ql-editor {
    font-size: 16px;
    line-height: 1.75;
  }

  .ql-container {
    border-bottom-left-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
  }

  .ql-toolbar {
    border-top-left-radius: 0.5rem;
    border-top-right-radius: 0.5rem;
    background-color: #f9fafb;
  }
</style>
</BaseLayout>
