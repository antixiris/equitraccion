---
// Admin New Post Editor v2 - Con Editor Visual WYSIWYG
import BaseLayout from '../../../layouts/BaseLayout.astro';

const title = 'Nuevo Post | Equitracción CMS';
---

<BaseLayout title={title} mode="hybrid">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-4xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <a href="/admin/posts" class="text-gray-600 hover:text-gray-900">← Volver</a>
            <div>
              <h1 class="font-heading font-bold text-2xl text-gray-900">Nuevo Post</h1>
              <p class="text-base text-gray-600">Crea un nuevo artículo para el blog</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="save-draft-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-gray-700 text-base">
              Guardar Borrador
            </button>
            <button id="publish-btn" class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium text-base">
              Publicar
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-6 py-8">
      <div class="space-y-6">
        <!-- Basic Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <h2 class="font-heading font-bold text-lg mb-4">Información Básica</h2>

          <div class="space-y-4">
            <!-- Title -->
            <div>
              <label for="title" class="block text-base font-medium text-gray-700 mb-2">
                Título del Post *
              </label>
              <input
                type="text"
                id="title"
                required
                placeholder="Ej: Beneficios de la Tracción Equina en Bosques"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 focus:border-transparent text-base"
              />
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <!-- Category -->
              <div>
                <label for="category" class="block text-base font-medium text-gray-700 mb-2">
                  Categoría *
                </label>
                <select
                  id="category"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 text-base"
                >
                  <option value="">Seleccionar...</option>
                  <option value="forestales">Silvicultura (Empresas)</option>
                  <option value="desarrollo">Desarrollo Personal</option>
                  <option value="formacion">Formación</option>
                  <option value="fundacion">Fundación</option>
                </select>
              </div>

              <!-- Author -->
              <div>
                <label for="author" class="block text-base font-medium text-gray-700 mb-2">
                  Autor *
                </label>
                <input
                  type="text"
                  id="author"
                  required
                  value="Roberto Contaldo"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 text-base"
                />
              </div>
            </div>

            <!-- Excerpt -->
            <div>
              <label for="excerpt" class="block text-base font-medium text-gray-700 mb-2">
                Resumen del Post *
              </label>
              <textarea
                id="excerpt"
                required
                rows="3"
                placeholder="Escribe un breve resumen de 2-3 frases"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 resize-none text-base"
              ></textarea>
            </div>

            <!-- Tags -->
            <div>
              <label for="tags" class="block text-base font-medium text-gray-700 mb-2">
                Etiquetas (separadas por comas)
              </label>
              <input
                type="text"
                id="tags"
                placeholder="Ej: tracción equina, sostenibilidad, gestión forestal"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-800 text-base"
              />
            </div>
          </div>
        </div>

        <!-- Cover Image -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <h2 class="font-heading font-bold text-lg mb-4">Imagen de Portada</h2>

          <div id="cover-upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-amber-800 transition-colors cursor-pointer">
            <input type="file" id="cover-image-input" accept="image/*" class="hidden" />
            <div id="cover-upload-prompt">
              <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p class="text-base font-medium text-gray-900 mb-2">Haz click o arrastra una imagen aquí</p>
              <p class="text-base text-gray-500">JPG, PNG o WebP • Máximo 5MB</p>
            </div>
            <div id="cover-preview" class="hidden">
              <img id="cover-preview-img" class="max-w-full max-h-64 mx-auto rounded-lg shadow-lg mb-4" />
              <button type="button" id="remove-cover" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-base">
                Eliminar Imagen
              </button>
            </div>
          </div>
          <input type="hidden" id="cover_image" />
        </div>

        <!-- Content Editor -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <h2 class="font-heading font-bold text-lg mb-4">Contenido del Post</h2>

          <!-- Toolbar -->
          <div class="border border-gray-300 rounded-t-lg bg-gray-50 p-3 flex flex-wrap gap-2">
            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('h1')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold text-2xl" title="Título Principal">
                T
              </button>
              <button type="button" onclick="formatText('h2')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold text-xl" title="Subtítulo">
                T
              </button>
              <button type="button" onclick="formatText('h3')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold text-lg" title="Sección">
                T
              </button>
            </div>

            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('bold')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold text-base" title="Negrita">
                <strong>N</strong>
              </button>
              <button type="button" onclick="formatText('italic')" class="px-3 py-2 hover:bg-gray-200 rounded italic text-base" title="Cursiva">
                <em>C</em>
              </button>
            </div>

            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('ul')" class="px-3 py-2 hover:bg-gray-200 rounded text-base" title="Lista">
                Lista
              </button>
              <button type="button" onclick="formatText('ol')" class="px-3 py-2 hover:bg-gray-200 rounded text-base" title="Lista Numerada">
                Numerada
              </button>
            </div>

            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('blockquote')" class="px-3 py-2 hover:bg-gray-200 rounded text-base" title="Cita">
                Cita
              </button>
              <button type="button" onclick="formatText('link')" class="px-3 py-2 hover:bg-gray-200 rounded text-base" title="Enlace">
                Enlace
              </button>
            </div>

            <div class="flex gap-1">
              <button type="button" id="insert-image-btn" class="px-3 py-2 hover:bg-gray-200 rounded bg-amber-50 text-amber-800 font-medium text-base" title="Insertar Imagen">
                Añadir Imagen
              </button>
            </div>
          </div>

          <!-- Editor Area -->
          <div
            id="editor"
            contenteditable="true"
            class="border border-gray-300 border-t-0 rounded-b-lg p-6 min-h-[500px] focus:outline-none max-w-none text-base"
            placeholder="Empieza a escribir aquí tu contenido..."
          ></div>

          <input type="hidden" id="content" />

          <p class="text-base text-gray-500 mt-4">
            <strong>Consejo:</strong> Escribe como en Word. Usa los botones de arriba para dar formato al texto. Puedes añadir imágenes directamente en el contenido.
          </p>
        </div>
      </div>
    </main>
  </div>

  <!-- Image Upload Modal -->
  <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Insertar Imagen</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-base font-medium text-gray-700 mb-2">
            Subir desde tu ordenador
          </label>
          <input type="file" id="content-image-input" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-base" />
        </div>

        <div class="text-center text-gray-500 text-base">— o —</div>

        <div>
          <label for="image-url-input" class="block text-base font-medium text-gray-700 mb-2">
            URL de imagen externa
          </label>
          <input
            type="url"
            id="image-url-input"
            placeholder="https://ejemplo.com/imagen.jpg"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-base"
          />
        </div>

        <div>
          <label for="image-alt-input" class="block text-base font-medium text-gray-700 mb-2">
            Descripción (opcional)
          </label>
          <input
            type="text"
            id="image-alt-input"
            placeholder="Describe la imagen para accesibilidad"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-base"
          />
        </div>
      </div>

      <div class="flex gap-3 justify-end mt-6">
        <button id="cancel-image" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-base">
          Cancelar
        </button>
        <button id="insert-image-confirm" class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium text-base">
          Insertar Imagen
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-800 mx-auto mb-4"></div>
      <p class="text-gray-900 font-medium text-base">Guardando post...</p>
    </div>
  </div>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  // Create Supabase client with public env vars
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  // Check authentication
  const checkAuth = () => {
    const isAuthenticated = sessionStorage.getItem('admin_authenticated');
    if (!isAuthenticated) {
      window.location.href = '/admin/login';
    }
  };

  // Generate slug from title
  const generateSlug = (title: string): string => {
    return title
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '');
  };

  // Cover image upload
  const coverUploadArea = document.getElementById('cover-upload-area')!;
  const coverImageInput = document.getElementById('cover-image-input') as HTMLInputElement;
  const coverPreview = document.getElementById('cover-preview')!;
  const coverPreviewImg = document.getElementById('cover-preview-img') as HTMLImageElement;
  const coverUploadPrompt = document.getElementById('cover-upload-prompt')!;
  const removeCoverBtn = document.getElementById('remove-cover')!;
  const coverImageField = document.getElementById('cover_image') as HTMLInputElement;

  coverUploadArea.addEventListener('click', () => {
    if (coverPreview.classList.contains('hidden')) {
      coverImageInput.click();
    }
  });

  coverUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    coverUploadArea.classList.add('border-[rgb(var(--color-brand-primary))]');
  });

  coverUploadArea.addEventListener('dragleave', () => {
    coverUploadArea.classList.remove('border-[rgb(var(--color-brand-primary))]');
  });

  coverUploadArea.addEventListener('drop', async (e) => {
    e.preventDefault();
    coverUploadArea.classList.remove('border-[rgb(var(--color-brand-primary))]');

    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      await uploadCoverImage(files[0]);
    }
  });

  coverImageInput.addEventListener('change', async (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (files && files.length > 0) {
      await uploadCoverImage(files[0]);
    }
  });

  removeCoverBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    coverPreview.classList.add('hidden');
    coverUploadPrompt.classList.remove('hidden');
    coverImageField.value = '';
    coverImageInput.value = '';
  });

  const uploadCoverImage = async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (!response.ok) {
        alert(result.error || 'Error al subir la imagen');
        return;
      }

      coverImageField.value = result.url;
      coverPreviewImg.src = result.url;
      coverUploadPrompt.classList.add('hidden');
      coverPreview.classList.remove('hidden');
    } catch (error) {
      console.error('Error uploading cover image:', error);
      alert('Error al subir la imagen');
    }
  };

  // Text formatting
  (window as any).formatText = (command: string) => {
    const editor = document.getElementById('editor')!;

    // Ensure editor has focus
    editor.focus();

    // If editor is empty, add a paragraph first
    if (editor.innerHTML.trim() === '' || editor.innerHTML === '<br>') {
      editor.innerHTML = '<p><br></p>';
      // Set cursor at the end
      const range = document.createRange();
      const sel = window.getSelection();
      range.selectNodeContents(editor);
      range.collapse(false);
      sel?.removeAllRanges();
      sel?.addRange(range);
    }

    switch (command) {
      case 'h1':
        document.execCommand('formatBlock', false, '<h1>');
        break;
      case 'h2':
        document.execCommand('formatBlock', false, '<h2>');
        break;
      case 'h3':
        document.execCommand('formatBlock', false, '<h3>');
        break;
      case 'bold':
        document.execCommand('bold', false);
        break;
      case 'italic':
        document.execCommand('italic', false);
        break;
      case 'ul':
        document.execCommand('insertUnorderedList', false);
        break;
      case 'ol':
        document.execCommand('insertOrderedList', false);
        break;
      case 'blockquote':
        document.execCommand('formatBlock', false, '<blockquote>');
        break;
      case 'link':
        const url = prompt('Introduce la URL del enlace:');
        if (url) {
          document.execCommand('createLink', false, url);
        }
        break;
    }

    // Return focus to editor
    editor.focus();
  };

  // Insert image in content
  document.getElementById('insert-image-btn')?.addEventListener('click', () => {
    document.getElementById('image-modal')!.classList.remove('hidden');
  });

  document.getElementById('cancel-image')?.addEventListener('click', () => {
    document.getElementById('image-modal')!.classList.add('hidden');
    (document.getElementById('content-image-input') as HTMLInputElement).value = '';
    (document.getElementById('image-url-input') as HTMLInputElement).value = '';
    (document.getElementById('image-alt-input') as HTMLInputElement).value = '';
  });

  document.getElementById('insert-image-confirm')?.addEventListener('click', async () => {
    const fileInput = document.getElementById('content-image-input') as HTMLInputElement;
    const urlInput = document.getElementById('image-url-input') as HTMLInputElement;
    const altInput = document.getElementById('image-alt-input') as HTMLInputElement;

    let imageUrl = urlInput.value.trim();

    // Upload file if provided
    if (fileInput.files && fileInput.files.length > 0) {
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        const response = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (!response.ok) {
          alert(result.error || 'Error al subir la imagen');
          return;
        }

        imageUrl = result.url;
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('Error al subir la imagen');
        return;
      }
    }

    if (!imageUrl) {
      alert('Por favor proporciona una imagen');
      return;
    }

    const editor = document.getElementById('editor')!;
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = altInput.value || '';
    img.className = 'max-w-full h-auto rounded-lg shadow-lg my-4';

    editor.focus();
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      range.insertNode(img);
      range.collapse(false);
    } else {
      editor.appendChild(img);
    }

    document.getElementById('image-modal')!.classList.add('hidden');
    fileInput.value = '';
    urlInput.value = '';
    altInput.value = '';
  });

  // Save post
  const savePost = async (published: boolean) => {
    const title = (document.getElementById('title') as HTMLInputElement).value.trim();
    const category = (document.getElementById('category') as HTMLSelectElement).value;
    const author = (document.getElementById('author') as HTMLInputElement).value.trim();
    const excerpt = (document.getElementById('excerpt') as HTMLTextAreaElement).value.trim();
    const tagsInput = (document.getElementById('tags') as HTMLInputElement).value.trim();
    const coverImage = (document.getElementById('cover_image') as HTMLInputElement).value.trim();

    // Get content from editor as HTML (keep formatting)
    const editorHtml = document.getElementById('editor')!.innerHTML;
    const content = editorHtml;

    // Validation
    if (!title || !category || !author || !excerpt) {
      alert('Por favor completa todos los campos obligatorios (*)');
      return;
    }

    if (!content || content.trim() === '' || content.trim() === '<p><br></p>') {
      alert('El contenido del post no puede estar vacío');
      return;
    }

    // Parse tags
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

    // Generate slug
    const slug = generateSlug(title);

    // Calculate reading time (extract text from HTML for word count)
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    const wordCount = textContent.split(/\s+/).filter(w => w.length > 0).length;
    const readingTime = Math.ceil(wordCount / 200);

    document.getElementById('loading-modal')!.classList.remove('hidden');

    try {
      const response = await fetch('/api/posts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          slug,
          excerpt,
          content,
          category,
          author,
          tags,
          cover_image: coverImage || null,
          reading_time: readingTime,
          published,
          published_at: published ? new Date().toISOString() : null
        })
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Error al guardar');
      }

      alert(published ? '¡Post publicado con éxito!' : '¡Borrador guardado con éxito!');
      window.location.href = '/admin/posts';
    } catch (error: any) {
      console.error('Error saving post:', error);
      if (error.message?.includes('slug') || error.message?.includes('título')) {
        alert('Ya existe un post con ese título. Por favor usa uno diferente.');
      } else {
        alert('Error al guardar el post: ' + error.message);
      }
    } finally {
      document.getElementById('loading-modal')!.classList.add('hidden');
    }
  };

  // Event listeners
  document.getElementById('save-draft-btn')?.addEventListener('click', () => savePost(false));
  document.getElementById('publish-btn')?.addEventListener('click', () => savePost(true));

  // Placeholder behavior
  const editor = document.getElementById('editor')!;
  editor.addEventListener('focus', () => {
    if (editor.innerHTML === '') {
      editor.innerHTML = '<p><br></p>';
    }
  });

  // Initialize
  checkAuth();
</script>

<style>
  /* Editor placeholder */
  #editor:empty:before {
    content: attr(placeholder);
    color: #9CA3AF;
    pointer-events: none;
  }

  /* Estilos para hacer el editor WYSIWYG visual */
  #editor {
    line-height: 1.75;
  }

  /* Encabezados */
  #editor h1 {
    font-size: 2.25rem;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
    line-height: 1.2;
    color: #1a1a1a;
  }

  #editor h2 {
    font-size: 1.875rem;
    font-weight: 700;
    margin-top: 1.75rem;
    margin-bottom: 0.875rem;
    line-height: 1.3;
    color: #1a1a1a;
  }

  #editor h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.4;
    color: #1a1a1a;
  }

  /* Párrafos */
  #editor p {
    margin-bottom: 1.25rem;
    color: #374151;
  }

  /* Texto enriquecido */
  #editor strong,
  #editor b {
    font-weight: 700;
    color: #1a1a1a;
  }

  #editor em,
  #editor i {
    font-style: italic;
    color: #4b5563;
  }

  /* Listas */
  #editor ul,
  #editor ol {
    margin-left: 1.5rem;
    margin-bottom: 1.25rem;
    padding-left: 0.5rem;
  }

  #editor ul {
    list-style-type: disc;
  }

  #editor ol {
    list-style-type: decimal;
  }

  #editor li {
    margin-bottom: 0.5rem;
    padding-left: 0.25rem;
    color: #374151;
  }

  #editor ul ul,
  #editor ol ol,
  #editor ul ol,
  #editor ol ul {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  /* Citas */
  #editor blockquote {
    border-left: 4px solid #92400e;
    padding-left: 1.25rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #6b7280;
    background-color: #fef3c7;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  #editor blockquote p {
    margin-bottom: 0.5rem;
  }

  #editor blockquote p:last-child {
    margin-bottom: 0;
  }

  /* Enlaces */
  #editor a {
    color: #92400e;
    text-decoration: underline;
    text-decoration-color: #d97706;
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
    transition: all 0.2s;
  }

  #editor a:hover {
    color: #78350f;
    text-decoration-color: #92400e;
  }

  /* Imágenes */
  #editor img {
    max-width: 100%;
    height: auto;
    border-radius: 0.75rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    margin: 1.5rem auto;
    display: block;
  }

  /* Código */
  #editor code {
    background-color: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #92400e;
  }

  #editor pre {
    background-color: #f3f4f6;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.25rem 0;
  }

  #editor pre code {
    background-color: transparent;
    padding: 0;
  }

  /* Líneas horizontales */
  #editor hr {
    border: none;
    border-top: 2px solid #e5e7eb;
    margin: 2rem 0;
  }
</style>
</BaseLayout>
