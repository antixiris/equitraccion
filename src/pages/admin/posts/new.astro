---
// Admin New Post Editor v2 - Con Editor Visual WYSIWYG
import BaseLayout from '../../../layouts/BaseLayout.astro';

const title = 'Nuevo Post | Equitracci√≥n CMS';
---

<BaseLayout title={title} mode="hybrid">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
      <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="/admin/posts" class="text-gray-600 hover:text-gray-900">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
          </a>
          <div>
            <h1 class="text-xl font-bold text-gray-900">Nuevo Post</h1>
            <p class="text-sm text-gray-500">Crea un nuevo art√≠culo para el blog</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="save-draft-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-gray-700">
            üíæ Guardar Borrador
          </button>
          <button id="publish-btn" class="px-4 py-2 bg-[rgb(var(--color-brand-primary))] text-white rounded-lg hover:opacity-90 font-medium">
            ‚úÖ Publicar
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-6 py-8">
      <div class="space-y-6">
        <!-- Basic Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-6">üìã Informaci√≥n B√°sica</h2>

          <div class="grid md:grid-cols-2 gap-6">
            <!-- Title -->
            <div class="md:col-span-2">
              <label for="title" class="block text-sm font-semibold text-gray-700 mb-2">
                T√≠tulo del Post *
              </label>
              <input
                type="text"
                id="title"
                required
                placeholder="Ej: Beneficios de la Tracci√≥n Equina en Bosques"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))] text-lg"
              />
            </div>

            <!-- Category -->
            <div>
              <label for="category" class="block text-sm font-semibold text-gray-700 mb-2">
                Categor√≠a *
              </label>
              <select
                id="category"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              >
                <option value="">Selecciona una categor√≠a</option>
                <option value="forestales">üå≤ Silvicultura (Empresas)</option>
                <option value="desarrollo">üê¥ Desarrollo Personal</option>
                <option value="formacion">üìö Formaci√≥n</option>
                <option value="fundacion">‚ù§Ô∏è Fundaci√≥n</option>
              </select>
            </div>

            <!-- Author -->
            <div>
              <label for="author" class="block text-sm font-semibold text-gray-700 mb-2">
                Autor *
              </label>
              <input
                type="text"
                id="author"
                required
                value="Roberto Contaldo"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              />
            </div>

            <!-- Excerpt -->
            <div class="md:col-span-2">
              <label for="excerpt" class="block text-sm font-semibold text-gray-700 mb-2">
                Resumen del Post *
              </label>
              <textarea
                id="excerpt"
                required
                rows="3"
                placeholder="Escribe un breve resumen de 2-3 frases. Esto aparecer√° en el listado del blog."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))] resize-none"
              ></textarea>
            </div>

            <!-- Tags -->
            <div class="md:col-span-2">
              <label for="tags" class="block text-sm font-semibold text-gray-700 mb-2">
                Etiquetas (separadas por comas)
              </label>
              <input
                type="text"
                id="tags"
                placeholder="Ej: tracci√≥n equina, sostenibilidad, gesti√≥n forestal"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              />
            </div>
          </div>
        </div>

        <!-- Cover Image -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-6">üñºÔ∏è Imagen de Portada</h2>

          <div id="cover-upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-[rgb(var(--color-brand-primary))] transition-colors cursor-pointer">
            <input type="file" id="cover-image-input" accept="image/*" class="hidden" />
            <div id="cover-upload-prompt">
              <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p class="text-lg font-medium text-gray-900 mb-2">Haz click o arrastra una imagen aqu√≠</p>
              <p class="text-sm text-gray-500">JPG, PNG o WebP ‚Ä¢ M√°ximo 5MB</p>
            </div>
            <div id="cover-preview" class="hidden">
              <img id="cover-preview-img" class="max-w-full max-h-64 mx-auto rounded-lg shadow-lg mb-4" />
              <button type="button" id="remove-cover" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                üóëÔ∏è Eliminar Imagen
              </button>
            </div>
          </div>
          <input type="hidden" id="cover_image" />
        </div>

        <!-- Content Editor -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-6">‚úèÔ∏è Contenido del Post</h2>

          <!-- Toolbar -->
          <div class="border border-gray-300 rounded-t-lg bg-gray-50 p-3 flex flex-wrap gap-2">
            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('h1')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold text-2xl" title="T√≠tulo Principal">
                T
              </button>
              <button type="button" onclick="formatText('h2')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold text-xl" title="Subt√≠tulo">
                T
              </button>
              <button type="button" onclick="formatText('h3')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold text-lg" title="Secci√≥n">
                T
              </button>
            </div>

            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('bold')" class="px-3 py-2 hover:bg-gray-200 rounded font-bold" title="Negrita">
                <strong>N</strong>
              </button>
              <button type="button" onclick="formatText('italic')" class="px-3 py-2 hover:bg-gray-200 rounded italic" title="Cursiva">
                <em>C</em>
              </button>
            </div>

            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('ul')" class="px-3 py-2 hover:bg-gray-200 rounded" title="Lista">
                ‚Ä¢ Lista
              </button>
              <button type="button" onclick="formatText('ol')" class="px-3 py-2 hover:bg-gray-200 rounded" title="Lista Numerada">
                1. Numerada
              </button>
            </div>

            <div class="flex gap-1 border-r border-gray-300 pr-2">
              <button type="button" onclick="formatText('blockquote')" class="px-3 py-2 hover:bg-gray-200 rounded" title="Cita">
                üí¨ Cita
              </button>
              <button type="button" onclick="formatText('link')" class="px-3 py-2 hover:bg-gray-200 rounded" title="Enlace">
                üîó Enlace
              </button>
            </div>

            <div class="flex gap-1">
              <button type="button" id="insert-image-btn" class="px-3 py-2 hover:bg-gray-200 rounded bg-blue-50 text-blue-700 font-medium" title="Insertar Imagen">
                üñºÔ∏è A√±adir Imagen
              </button>
            </div>
          </div>

          <!-- Editor Area -->
          <div
            id="editor"
            contenteditable="true"
            class="border border-gray-300 border-t-0 rounded-b-lg p-6 min-h-[500px] focus:outline-none prose prose-lg max-w-none"
            placeholder="Empieza a escribir aqu√≠ tu contenido..."
          ></div>

          <input type="hidden" id="content" />

          <p class="text-sm text-gray-500 mt-4">
            üí° <strong>Consejo:</strong> Escribe como en Word. Usa los botones de arriba para dar formato al texto. Puedes a√±adir im√°genes directamente en el contenido.
          </p>
        </div>
      </div>
    </main>
  </div>

  <!-- Image Upload Modal -->
  <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-4">üì∑ Insertar Imagen</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Subir desde tu ordenador
          </label>
          <input type="file" id="content-image-input" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
        </div>

        <div class="text-center text-gray-500">‚Äî o ‚Äî</div>

        <div>
          <label for="image-url-input" class="block text-sm font-semibold text-gray-700 mb-2">
            URL de imagen externa
          </label>
          <input
            type="url"
            id="image-url-input"
            placeholder="https://ejemplo.com/imagen.jpg"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
          />
        </div>

        <div>
          <label for="image-alt-input" class="block text-sm font-semibold text-gray-700 mb-2">
            Descripci√≥n (opcional)
          </label>
          <input
            type="text"
            id="image-alt-input"
            placeholder="Describe la imagen para accesibilidad"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
          />
        </div>
      </div>

      <div class="flex gap-3 justify-end mt-6">
        <button id="cancel-image" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
          Cancelar
        </button>
        <button id="insert-image-confirm" class="px-4 py-2 bg-[rgb(var(--color-brand-primary))] text-white rounded-lg hover:opacity-90 font-medium">
          Insertar Imagen
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[rgb(var(--color-brand-primary))] mx-auto mb-4"></div>
      <p class="text-gray-900 font-medium">Guardando post...</p>
    </div>
  </div>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';
  import TurndownService from 'turndown';

  // Create Supabase client with public env vars
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  const turndownService = new TurndownService({
    headingStyle: 'atx',
    codeBlockStyle: 'fenced'
  });

  // Check authentication
  const checkAuth = () => {
    const isAuthenticated = sessionStorage.getItem('admin_authenticated');
    if (!isAuthenticated) {
      window.location.href = '/admin/login';
    }
  };

  // Generate slug from title
  const generateSlug = (title: string): string => {
    return title
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '');
  };

  // Cover image upload
  const coverUploadArea = document.getElementById('cover-upload-area')!;
  const coverImageInput = document.getElementById('cover-image-input') as HTMLInputElement;
  const coverPreview = document.getElementById('cover-preview')!;
  const coverPreviewImg = document.getElementById('cover-preview-img') as HTMLImageElement;
  const coverUploadPrompt = document.getElementById('cover-upload-prompt')!;
  const removeCoverBtn = document.getElementById('remove-cover')!;
  const coverImageField = document.getElementById('cover_image') as HTMLInputElement;

  coverUploadArea.addEventListener('click', () => {
    if (coverPreview.classList.contains('hidden')) {
      coverImageInput.click();
    }
  });

  coverUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    coverUploadArea.classList.add('border-[rgb(var(--color-brand-primary))]');
  });

  coverUploadArea.addEventListener('dragleave', () => {
    coverUploadArea.classList.remove('border-[rgb(var(--color-brand-primary))]');
  });

  coverUploadArea.addEventListener('drop', async (e) => {
    e.preventDefault();
    coverUploadArea.classList.remove('border-[rgb(var(--color-brand-primary))]');

    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      await uploadCoverImage(files[0]);
    }
  });

  coverImageInput.addEventListener('change', async (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (files && files.length > 0) {
      await uploadCoverImage(files[0]);
    }
  });

  removeCoverBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    coverPreview.classList.add('hidden');
    coverUploadPrompt.classList.remove('hidden');
    coverImageField.value = '';
    coverImageInput.value = '';
  });

  const uploadCoverImage = async (file: File) => {
    const formData = new FormData();
    formData.append('image', file);

    try {
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (!response.ok) {
        alert(result.error || 'Error al subir la imagen');
        return;
      }

      coverImageField.value = result.url;
      coverPreviewImg.src = result.url;
      coverUploadPrompt.classList.add('hidden');
      coverPreview.classList.remove('hidden');
    } catch (error) {
      console.error('Error uploading cover image:', error);
      alert('Error al subir la imagen');
    }
  };

  // Text formatting
  (window as any).formatText = (command: string) => {
    const editor = document.getElementById('editor')!;
    editor.focus();

    switch (command) {
      case 'h1':
      case 'h2':
      case 'h3':
        document.execCommand('formatBlock', false, command);
        break;
      case 'bold':
        document.execCommand('bold', false);
        break;
      case 'italic':
        document.execCommand('italic', false);
        break;
      case 'ul':
        document.execCommand('insertUnorderedList', false);
        break;
      case 'ol':
        document.execCommand('insertOrderedList', false);
        break;
      case 'blockquote':
        document.execCommand('formatBlock', false, 'blockquote');
        break;
      case 'link':
        const url = prompt('Introduce la URL del enlace:');
        if (url) {
          document.execCommand('createLink', false, url);
        }
        break;
    }
  };

  // Insert image in content
  document.getElementById('insert-image-btn')?.addEventListener('click', () => {
    document.getElementById('image-modal')!.classList.remove('hidden');
  });

  document.getElementById('cancel-image')?.addEventListener('click', () => {
    document.getElementById('image-modal')!.classList.add('hidden');
    (document.getElementById('content-image-input') as HTMLInputElement).value = '';
    (document.getElementById('image-url-input') as HTMLInputElement).value = '';
    (document.getElementById('image-alt-input') as HTMLInputElement).value = '';
  });

  document.getElementById('insert-image-confirm')?.addEventListener('click', async () => {
    const fileInput = document.getElementById('content-image-input') as HTMLInputElement;
    const urlInput = document.getElementById('image-url-input') as HTMLInputElement;
    const altInput = document.getElementById('image-alt-input') as HTMLInputElement;

    let imageUrl = urlInput.value.trim();

    // Upload file if provided
    if (fileInput.files && fileInput.files.length > 0) {
      const formData = new FormData();
      formData.append('image', fileInput.files[0]);

      try {
        const response = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (!response.ok) {
          alert(result.error || 'Error al subir la imagen');
          return;
        }

        imageUrl = result.url;
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('Error al subir la imagen');
        return;
      }
    }

    if (!imageUrl) {
      alert('Por favor proporciona una imagen');
      return;
    }

    const editor = document.getElementById('editor')!;
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = altInput.value || '';
    img.className = 'max-w-full h-auto rounded-lg shadow-lg my-4';

    editor.focus();
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      range.insertNode(img);
      range.collapse(false);
    } else {
      editor.appendChild(img);
    }

    document.getElementById('image-modal')!.classList.add('hidden');
    fileInput.value = '';
    urlInput.value = '';
    altInput.value = '';
  });

  // Save post
  const savePost = async (published: boolean) => {
    const title = (document.getElementById('title') as HTMLInputElement).value.trim();
    const category = (document.getElementById('category') as HTMLSelectElement).value;
    const author = (document.getElementById('author') as HTMLInputElement).value.trim();
    const excerpt = (document.getElementById('excerpt') as HTMLTextAreaElement).value.trim();
    const tagsInput = (document.getElementById('tags') as HTMLInputElement).value.trim();
    const coverImage = (document.getElementById('cover_image') as HTMLInputElement).value.trim();

    // Get content from editor and convert to Markdown
    const editorHtml = document.getElementById('editor')!.innerHTML;
    const content = turndownService.turndown(editorHtml);

    // Validation
    if (!title || !category || !author || !excerpt) {
      alert('Por favor completa todos los campos obligatorios (*)');
      return;
    }

    if (!content || content.trim() === '') {
      alert('El contenido del post no puede estar vac√≠o');
      return;
    }

    // Parse tags
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

    // Generate slug
    const slug = generateSlug(title);

    // Calculate reading time
    const wordCount = content.split(/\s+/).length;
    const readingTime = Math.ceil(wordCount / 200);

    document.getElementById('loading-modal')!.classList.remove('hidden');

    try {
      const response = await fetch('/api/posts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          slug,
          excerpt,
          content,
          category,
          author,
          tags,
          cover_image: coverImage || null,
          reading_time: readingTime,
          published,
          published_at: published ? new Date().toISOString() : null
        })
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Error al guardar');
      }

      alert(published ? '¬°Post publicado con √©xito!' : '¬°Borrador guardado con √©xito!');
      window.location.href = '/admin/posts';
    } catch (error: any) {
      console.error('Error saving post:', error);
      if (error.message?.includes('slug') || error.message?.includes('t√≠tulo')) {
        alert('Ya existe un post con ese t√≠tulo. Por favor usa uno diferente.');
      } else {
        alert('Error al guardar el post: ' + error.message);
      }
    } finally {
      document.getElementById('loading-modal')!.classList.add('hidden');
    }
  };

  // Event listeners
  document.getElementById('save-draft-btn')?.addEventListener('click', () => savePost(false));
  document.getElementById('publish-btn')?.addEventListener('click', () => savePost(true));

  // Placeholder behavior
  const editor = document.getElementById('editor')!;
  editor.addEventListener('focus', () => {
    if (editor.innerHTML === '') {
      editor.innerHTML = '<p><br></p>';
    }
  });

  // Initialize
  checkAuth();
</script>

<style>
  #editor:empty:before {
    content: attr(placeholder);
    color: #9CA3AF;
    pointer-events: none;
  }

  #editor img {
    max-width: 100%;
    height: auto;
  }

  #editor blockquote {
    border-left: 4px solid #2F5233;
    padding-left: 1rem;
    font-style: italic;
    color: #6B7280;
  }
</style>
</BaseLayout>
