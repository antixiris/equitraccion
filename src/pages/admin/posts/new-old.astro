---
// Admin New Post Editor
import BaseLayout from '../../../layouts/BaseLayout.astro';

const title = 'Nuevo Post | Equitracci√≥n CMS';
---

<BaseLayout title={title} mode="hybrid">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
      <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="/admin/posts" class="text-gray-600 hover:text-gray-900">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
          </a>
          <div>
            <h1 class="text-xl font-bold text-gray-900">Nuevo Post</h1>
            <p class="text-sm text-gray-500">Crea un nuevo art√≠culo para el blog</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="save-draft-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-gray-700">
            Guardar Borrador
          </button>
          <button id="publish-btn" class="px-4 py-2 bg-[rgb(var(--color-brand-primary))] text-white rounded-lg hover:opacity-90 font-medium">
            Publicar
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
      <div class="grid lg:grid-cols-2 gap-8">
        <!-- Editor Panel -->
        <div class="space-y-6">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-bold text-gray-900 mb-6">Informaci√≥n del Post</h2>

            <!-- Title -->
            <div class="mb-6">
              <label for="title" class="block text-sm font-semibold text-gray-700 mb-2">
                T√≠tulo *
              </label>
              <input
                type="text"
                id="title"
                required
                placeholder="Escribe un t√≠tulo atractivo..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))] text-lg"
              />
              <p class="text-xs text-gray-500 mt-1">El t√≠tulo aparecer√° en el listado del blog</p>
            </div>

            <!-- Slug -->
            <div class="mb-6">
              <label for="slug" class="block text-sm font-semibold text-gray-700 mb-2">
                URL (Slug) *
              </label>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">/blog/</span>
                <input
                  type="text"
                  id="slug"
                  required
                  placeholder="mi-post-url"
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
                />
              </div>
              <p class="text-xs text-gray-500 mt-1">Solo min√∫sculas, n√∫meros y guiones. Se genera autom√°ticamente del t√≠tulo.</p>
            </div>

            <!-- Excerpt -->
            <div class="mb-6">
              <label for="excerpt" class="block text-sm font-semibold text-gray-700 mb-2">
                Extracto / Resumen *
              </label>
              <textarea
                id="excerpt"
                required
                rows="3"
                placeholder="Breve descripci√≥n del post (2-3 frases)..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))] resize-none"
              ></textarea>
              <p class="text-xs text-gray-500 mt-1">Aparecer√° en el listado del blog y SEO</p>
            </div>

            <!-- Category -->
            <div class="mb-6">
              <label for="category" class="block text-sm font-semibold text-gray-700 mb-2">
                Categor√≠a *
              </label>
              <select
                id="category"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              >
                <option value="">Selecciona una categor√≠a</option>
                <option value="forestales">Silvicultura (B2B)</option>
                <option value="desarrollo">Desarrollo Personal (B2C)</option>
                <option value="formacion">Formaci√≥n</option>
                <option value="fundacion">Fundaci√≥n</option>
              </select>
            </div>

            <!-- Author -->
            <div class="mb-6">
              <label for="author" class="block text-sm font-semibold text-gray-700 mb-2">
                Autor *
              </label>
              <input
                type="text"
                id="author"
                required
                value="Roberto Contaldo"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              />
            </div>

            <!-- Tags -->
            <div class="mb-6">
              <label for="tags" class="block text-sm font-semibold text-gray-700 mb-2">
                Etiquetas (Tags)
              </label>
              <input
                type="text"
                id="tags"
                placeholder="tracci√≥n equina, sostenibilidad, gesti√≥n forestal"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              />
              <p class="text-xs text-gray-500 mt-1">Separados por comas</p>
            </div>

            <!-- Cover Image -->
            <div class="mb-6">
              <label for="cover_image" class="block text-sm font-semibold text-gray-700 mb-2">
                Imagen de Portada
              </label>
              <input
                type="text"
                id="cover_image"
                placeholder="/images/blog/mi-imagen.jpg"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              />
              <p class="text-xs text-gray-500 mt-1">URL de la imagen o ruta local</p>
            </div>

            <!-- Reading Time -->
            <div class="mb-6">
              <label for="reading_time" class="block text-sm font-semibold text-gray-700 mb-2">
                Tiempo de Lectura (minutos)
              </label>
              <input
                type="number"
                id="reading_time"
                placeholder="8"
                min="1"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
              />
              <p class="text-xs text-gray-500 mt-1">Opcional: se calcula autom√°ticamente</p>
            </div>
          </div>

          <!-- Markdown Editor -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-gray-900">Contenido (Markdown)</h2>
              <a
                href="https://www.markdownguide.org/cheat-sheet/"
                target="_blank"
                class="text-sm text-blue-600 hover:underline"
              >
                Gu√≠a Markdown
              </a>
            </div>

            <!-- Markdown Toolbar -->
            <div class="flex flex-wrap gap-2 mb-4 pb-4 border-b border-gray-200">
              <button onclick="insertMarkdown('**', '**')" class="p-2 hover:bg-gray-100 rounded" title="Negrita">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 12h12M6 6h12M6 18h12" />
                </svg>
              </button>
              <button onclick="insertMarkdown('*', '*')" class="p-2 hover:bg-gray-100 rounded italic" title="Cursiva">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6L8 18M14 6l-2 12M4 6h16M4 18h16" />
                </svg>
              </button>
              <button onclick="insertMarkdown('## ', '')" class="p-2 hover:bg-gray-100 rounded font-bold" title="T√≠tulo H2">
                H2
              </button>
              <button onclick="insertMarkdown('### ', '')" class="p-2 hover:bg-gray-100 rounded font-bold" title="T√≠tulo H3">
                H3
              </button>
              <button onclick="insertMarkdown('[', '](url)')" class="p-2 hover:bg-gray-100 rounded" title="Enlace">
                üîó
              </button>
              <button onclick="insertMarkdown('- ', '')" class="p-2 hover:bg-gray-100 rounded" title="Lista">
                ‚Ä¢ Lista
              </button>
              <button onclick="insertMarkdown('> ', '')" class="p-2 hover:bg-gray-100 rounded" title="Cita">
                ""
              </button>
            </div>

            <textarea
              id="content"
              rows="20"
              required
              placeholder="# T√≠tulo Principal

Escribe aqu√≠ el contenido de tu post usando Markdown...

## Subt√≠tulo

- Lista de items
- Otro item

**Texto en negrita** y *texto en cursiva*.

[Enlace a p√°gina](https://ejemplo.com)"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))] font-mono text-sm resize-none"
            ></textarea>
          </div>
        </div>

        <!-- Preview Panel -->
        <div class="lg:sticky lg:top-24 lg:h-[calc(100vh-8rem)] lg:overflow-y-auto">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-bold text-gray-900 mb-6">Vista Previa</h2>
            <div id="preview-container" class="prose prose-lg max-w-none
              prose-headings:font-heading prose-headings:font-bold
              prose-p:leading-relaxed
              prose-a:text-[rgb(var(--color-brand-primary))] prose-a:no-underline hover:prose-a:underline
              prose-ul:text-[rgb(var(--color-gray-dark))]
              prose-ol:text-[rgb(var(--color-gray-dark))]
              prose-blockquote:border-l-4 prose-blockquote:border-[rgb(var(--color-brand-primary))]
              prose-blockquote:text-[rgb(var(--color-gray-medium))] prose-blockquote:italic
            ">
              <p class="text-gray-400 italic">El contenido aparecer√° aqu√≠ mientras escribes...</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[rgb(var(--color-brand-primary))] mx-auto mb-4"></div>
      <p class="text-gray-900 font-medium">Guardando post...</p>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../../../lib/supabase';
  import MarkdownIt from 'markdown-it';

  const md = new MarkdownIt();

  // Check authentication
  const checkAuth = () => {
    const isAuthenticated = sessionStorage.getItem('admin_authenticated');
    if (!isAuthenticated) {
      window.location.href = '/admin/login';
    }
  };

  // Generate slug from title
  const generateSlug = (title: string): string => {
    return title
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '');
  };

  // Insert markdown
  (window as any).insertMarkdown = (before: string, after: string) => {
    const textarea = document.getElementById('content') as HTMLTextAreaElement;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end) || 'texto';

    textarea.value = text.substring(0, start) + before + selectedText + after + text.substring(end);
    textarea.focus();
    textarea.selectionStart = start + before.length;
    textarea.selectionEnd = start + before.length + selectedText.length;

    updatePreview();
  };

  // Update preview
  const updatePreview = () => {
    const content = (document.getElementById('content') as HTMLTextAreaElement).value;
    const preview = document.getElementById('preview-container')!;

    if (content.trim()) {
      preview.innerHTML = md.render(content);
    } else {
      preview.innerHTML = '<p class="text-gray-400 italic">El contenido aparecer√° aqu√≠ mientras escribes...</p>';
    }
  };

  // Auto-generate slug
  document.getElementById('title')?.addEventListener('input', (e) => {
    const title = (e.target as HTMLInputElement).value;
    const slugInput = document.getElementById('slug') as HTMLInputElement;
    if (!slugInput.dataset.manuallyEdited) {
      slugInput.value = generateSlug(title);
    }
  });

  document.getElementById('slug')?.addEventListener('input', () => {
    (document.getElementById('slug') as HTMLInputElement).dataset.manuallyEdited = 'true';
  });

  // Update preview on content change
  document.getElementById('content')?.addEventListener('input', updatePreview);

  // Save post
  const savePost = async (published: boolean) => {
    const title = (document.getElementById('title') as HTMLInputElement).value.trim();
    const slug = (document.getElementById('slug') as HTMLInputElement).value.trim();
    const excerpt = (document.getElementById('excerpt') as HTMLTextAreaElement).value.trim();
    const content = (document.getElementById('content') as HTMLTextAreaElement).value.trim();
    const category = (document.getElementById('category') as HTMLSelectElement).value;
    const author = (document.getElementById('author') as HTMLInputElement).value.trim();
    const tagsInput = (document.getElementById('tags') as HTMLInputElement).value.trim();
    const coverImage = (document.getElementById('cover_image') as HTMLInputElement).value.trim();
    const readingTimeInput = (document.getElementById('reading_time') as HTMLInputElement).value;

    // Validation
    if (!title || !slug || !excerpt || !content || !category || !author) {
      alert('Por favor completa todos los campos obligatorios (*)');
      return;
    }

    // Parse tags
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

    // Calculate reading time if not provided
    const wordCount = content.split(/\s+/).length;
    const readingTime = readingTimeInput ? parseInt(readingTimeInput) : Math.ceil(wordCount / 200);

    document.getElementById('loading-modal')!.classList.remove('hidden');

    try {
      const { data, error } = await supabase
        .from('blog_posts')
        .insert([{
          title,
          slug,
          excerpt,
          content,
          category,
          author,
          tags,
          cover_image: coverImage || null,
          reading_time: readingTime,
          published,
          published_at: published ? new Date().toISOString() : null
        }])
        .select()
        .single();

      if (error) throw error;

      alert(published ? '¬°Post publicado con √©xito!' : '¬°Borrador guardado con √©xito!');
      window.location.href = '/admin/posts';
    } catch (error: any) {
      console.error('Error saving post:', error);
      if (error.code === '23505') {
        alert('Ya existe un post con ese slug. Por favor usa uno diferente.');
      } else {
        alert('Error al guardar el post: ' + error.message);
      }
    } finally {
      document.getElementById('loading-modal')!.classList.add('hidden');
    }
  };

  // Event listeners
  document.getElementById('save-draft-btn')?.addEventListener('click', () => savePost(false));
  document.getElementById('publish-btn')?.addEventListener('click', () => savePost(true));

  // Initialize
  checkAuth();
</script>
</BaseLayout>
