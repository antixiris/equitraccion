---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { isAuthenticated } from '../../lib/auth/jwt';
import { supabaseAdmin } from '../../lib/supabase';
import type { Course } from '../../lib/supabase';

if (!isAuthenticated(Astro)) {
  return Astro.redirect('/admin/login');
}

const { data: courses, error } = await supabaseAdmin
  .from('courses')
  .select('*')
  .order('created_at', { ascending: false });

if (error) {
  console.error('Error fetching courses:', error);
}
---

<BaseLayout
  title="Gestión de Cursos | Admin"
  description="Panel de administración de cursos"
  mode="hybrid"
>
  <main class="min-h-screen bg-gray-50">
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-8">
            <nav class="flex items-center gap-6">
              <a href="/admin" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Dashboard
              </a>
              <a href="/admin/posts" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Blog
              </a>
              <a href="/admin/courses" class="text-base font-semibold text-amber-800 border-b-2 border-amber-800 pb-1">
                Cursos
              </a>
              <a href="/admin/newsletter" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Newsletter
              </a>
              <a href="/admin/messages" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Mensajes
              </a>
            </nav>
            <div class="border-l pl-8">
              <h1 class="font-heading font-bold text-2xl text-gray-900">Gestión de Cursos</h1>
              <p class="text-sm text-gray-600">Administra los cursos y sus convocatorias</p>
            </div>
          </div>
          <form id="logout-form" action="/api/auth/logout" method="POST">
            <button type="submit" class="text-base text-gray-600 hover:text-gray-900">
              Cerrar sesión
            </button>
          </form>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="mb-6 flex justify-between items-center">
        <p class="text-base text-gray-600">
          {courses?.length || 0} cursos registrados
        </p>
        <a
          href="/admin/courses/new"
          class="px-6 py-3 bg-amber-800 text-white rounded-lg font-medium hover:bg-amber-900 transition-colors"
        >
          + Nuevo Curso
        </a>
      </div>

      {courses && courses.length > 0 ? (
        <div class="grid gap-6">
          {courses.map((course: Course) => {
            const now = new Date();
            const upcomingDates = course.dates
              .filter(d => new Date(d.start) > now)
              .sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());

            return (
              <article class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <h2 class="font-heading font-bold text-2xl text-gray-900">
                        {course.title}
                      </h2>
                      <span class={`px-3 py-1 rounded-full text-sm font-semibold ${
                        course.active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                      }`}>
                        {course.active ? 'Activo' : 'Inactivo'}
                      </span>
                      <span class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-700">
                        Nivel {course.level} - {course.experience_level}
                      </span>
                    </div>
                    <p class="text-base text-gray-600">
                      {course.duration_days} días · {course.max_participants} plazas · {course.price}€
                    </p>
                  </div>
                  <div class="flex gap-2">
                    <a
                      href={`/admin/courses/edit/${course.id}`}
                      class="px-4 py-2 text-base border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Editar
                    </a>
                    <button
                      class="px-4 py-2 text-base text-red-600 border border-red-300 rounded-lg hover:bg-red-50 delete-course"
                      data-id={course.id}
                      data-title={course.title}
                    >
                      Eliminar
                    </button>
                  </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4 text-base">
                  <div>
                    <h3 class="font-semibold text-gray-900 mb-2">Ubicación:</h3>
                    <p class="text-gray-600">{course.location}</p>
                  </div>
                  <div>
                    <h3 class="font-semibold text-gray-900 mb-2">Próximas Convocatorias:</h3>
                    {upcomingDates.length > 0 ? (
                      <ul class="text-gray-600 space-y-1">
                        {upcomingDates.slice(0, 2).map(date => (
                          <li>
                            {new Date(date.start).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })} - {new Date(date.end).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })} ({date.spots_available} plazas)
                          </li>
                        ))}
                        {upcomingDates.length > 2 && (
                          <li class="text-gray-400">+ {upcomingDates.length - 2} más</li>
                        )}
                      </ul>
                    ) : (
                      <p class="text-gray-400">Sin convocatorias futuras</p>
                    )}
                  </div>
                </div>
              </article>
            );
          })}
        </div>
      ) : (
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
          <p class="text-lg text-gray-500 mb-4">No hay cursos registrados</p>
          <a
            href="/admin/courses/new"
            class="inline-block px-6 py-3 text-base bg-amber-800 text-white rounded-lg font-medium hover:bg-amber-900"
          >
            Crear primer curso
          </a>
        </div>
      )}
    </div>
  </main>
</BaseLayout>

<script>
  // Handle logout
  const logoutForm = document.getElementById('logout-form');
  logoutForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    sessionStorage.clear();
    window.location.replace('/admin/login');
  });

  const deleteButtons = document.querySelectorAll('.delete-course');

  deleteButtons.forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.getAttribute('data-id');
      const title = button.getAttribute('data-title');

      if (!confirm(`¿Eliminar "${title}"?\n\nEsta acción no se puede deshacer.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/courses/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const data = await response.json();
          alert(`Error: ${data.message || 'Error desconocido'}`);
        }
      } catch (error) {
        console.error('Error deleting course:', error);
        alert('Error de conexión');
      }
    });
  });
</script>
