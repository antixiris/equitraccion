---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import AdminNav from '../../../components/AdminNav.astro';
import { isAuthenticated } from '../../../lib/auth/jwt';

if (!isAuthenticated(Astro)) {
  return Astro.redirect('/admin/login');
}

const title = 'Mensajes de Contacto | Equitracción CMS';
---

<BaseLayout title={title} mode="hybrid">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <AdminNav currentPage="messages" title="Mensajes de Contacto" subtitle="Gestiona los mensajes recibidos del formulario de contacto" />

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
      <!-- Stats -->
      <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <p class="text-base text-gray-600 mb-1">Total Mensajes</p>
          <p id="total-messages" class="text-4xl font-bold text-gray-900">0</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <p class="text-base text-gray-600 mb-1">No Leídos</p>
          <p id="unread-messages" class="text-4xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <p class="text-base text-gray-600 mb-1">Leídos</p>
          <p id="read-messages" class="text-4xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <p class="text-base text-gray-600 mb-1">Hoy</p>
          <p id="today-messages" class="text-4xl font-bold text-amber-600">0</p>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex gap-4">
          <div class="flex-1">
            <input
              type="text"
              id="search-input"
              placeholder="Buscar por nombre, email o asunto..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
            />
          </div>
          <select
            id="filter-status"
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
          >
            <option value="all">Todos</option>
            <option value="unread">No leídos</option>
            <option value="read">Leídos</option>
          </select>
          <select
            id="filter-type"
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))]"
          >
            <option value="all">Todos los tipos</option>
            <option value="general">Consulta General</option>
            <option value="forestales">Servicios Forestales</option>
            <option value="formacion">Formación</option>
            <option value="desarrollo">Desarrollo Personal</option>
          </select>
        </div>
      </div>

      <!-- Messages List -->
      <div class="space-y-4" id="messages-container">
        <!-- Messages will be loaded here -->
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay mensajes</h3>
        <p class="text-gray-500">Los mensajes del formulario de contacto aparecerán aquí</p>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[rgb(var(--color-brand-primary))] mx-auto"></div>
        <p class="text-gray-500 mt-4">Cargando mensajes...</p>
      </div>
    </main>
  </div>

  <!-- Message Detail Modal -->
  <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200 flex items-center justify-between">
        <h3 id="modal-subject" class="text-xl font-bold text-gray-900"></h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-600 cursor-pointer">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-6 space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <p class="text-base text-gray-600">Nombre</p>
            <p id="modal-name" class="text-lg font-medium text-gray-900"></p>
          </div>
          <div>
            <p class="text-base text-gray-600">Email</p>
            <p id="modal-email" class="text-lg font-medium text-gray-900"></p>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <p class="text-base text-gray-600">Teléfono</p>
            <p id="modal-phone" class="text-lg font-medium text-gray-900"></p>
          </div>
          <div>
            <p class="text-base text-gray-600">Tipo de consulta</p>
            <p id="modal-type" class="text-lg font-medium text-gray-900"></p>
          </div>
        </div>

        <div>
          <p class="text-base text-gray-600 mb-2">Mensaje</p>
          <div id="modal-message" class="text-gray-900 p-4 bg-gray-50 rounded-lg whitespace-pre-wrap"></div>
        </div>

        <div>
          <p class="text-base text-gray-600">Recibido</p>
          <p id="modal-date" class="text-gray-900"></p>
        </div>
      </div>

      <div class="p-6 border-t border-gray-200 flex gap-3 justify-end">
        <button id="modal-delete" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 cursor-pointer">
          Eliminar
        </button>
        <button id="close-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 cursor-pointer">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  let allMessages: any[] = [];
  let currentMessageId: string | null = null;

  // Check authentication
  const checkAuth = () => {
    const isAuthenticated = sessionStorage.getItem('admin_authenticated');
    if (!isAuthenticated) {
      window.location.href = '/admin/login';
    }
  };

  // Load messages
  const loadMessages = async () => {
    try {
      const response = await fetch('/api/admin/messages/list');
      const result = await response.json();

      if (!result.success) {
        throw new Error(result.message);
      }

      allMessages = result.data || [];

      updateStats();
      renderMessages(allMessages);

      document.getElementById('loading-state')!.classList.add('hidden');

      if (allMessages.length === 0) {
        document.getElementById('empty-state')!.classList.remove('hidden');
      }

    } catch (error) {
      console.error('Error loading messages:', error);
      document.getElementById('loading-state')!.innerHTML = `
        <div class="p-12 text-center">
          <p class="text-red-600">Error al cargar los mensajes</p>
        </div>
      `;
    }
  };

  // Update stats
  const updateStats = () => {
    const total = allMessages.length;
    const unread = allMessages.filter(m => m.status === 'new').length;
    const read = total - unread;

    const today = new Date().toISOString().split('T')[0];
    const todayMessages = allMessages.filter(m => m.created_at.startsWith(today)).length;

    document.getElementById('total-messages')!.textContent = total.toString();
    document.getElementById('unread-messages')!.textContent = unread.toString();
    document.getElementById('read-messages')!.textContent = read.toString();
    document.getElementById('today-messages')!.textContent = todayMessages.toString();
  };

  // Render messages
  const renderMessages = (messages: any[]) => {
    const container = document.getElementById('messages-container')!;

    if (messages.length === 0) {
      container.innerHTML = '';
      document.getElementById('empty-state')!.classList.remove('hidden');
      return;
    }

    document.getElementById('empty-state')!.classList.add('hidden');

    container.innerHTML = messages.map(message => {
      const date = new Date(message.created_at);
      const formattedDate = date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 ${message.status === 'new' ? 'border-l-4 border-l-blue-500' : ''}">
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="text-lg font-bold text-gray-900">${message.subject || 'Sin asunto'}</h3>
                ${message.status === 'new' ? '<span class="px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded-full font-medium">NUEVO</span>' : ''}
              </div>
              <div class="flex items-center gap-4 text-base text-gray-600">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  ${message.name}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  ${message.email}
                </span>
                ${message.phone ? `<span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  ${message.phone}
                </span>` : ''}
              </div>
            </div>
            <span class="text-xs text-gray-500">${formattedDate}</span>
          </div>

          <p class="text-gray-700 mb-4 line-clamp-2">${message.message}</p>

          <div class="flex items-center justify-between">
            <span class="text-sm px-2 py-1 bg-gray-100 text-gray-600 rounded">${message.category || 'general'}</span>
            <div class="flex gap-2">
              <button
                onclick="toggleRead('${message.id}', '${message.status}')"
                class="px-3 py-1 text-base cursor-pointer ${message.status === 'read' ? 'text-gray-600 hover:text-gray-900' : 'text-blue-600 hover:text-blue-900'}"
              >
                ${message.status === 'read' ? '✗ Marcar no leído' : '✓ Marcar leído'}
              </button>
              <button
                onclick="viewMessage('${message.id}')"
                class="px-3 py-1 text-base text-blue-600 hover:text-blue-900 cursor-pointer"
              >
                Ver detalles
              </button>
              <button
                onclick="deleteMessage('${message.id}')"
                class="px-3 py-1 text-base text-red-600 hover:text-red-900 cursor-pointer"
              >
                Eliminar
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  };

  // Toggle read status
  (window as any).toggleRead = async (id: string, currentStatus: string) => {
    try {
      const newReadStatus = currentStatus === 'read' ? false : true;
      const response = await fetch(`/api/admin/messages/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ read: newReadStatus })
      });

      if (response.ok) {
        await loadMessages();
      } else {
        alert('Error al cambiar el estado');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al cambiar el estado');
    }
  };

  // View message detail
  (window as any).viewMessage = async (id: string) => {
    const message = allMessages.find(m => m.id === id);
    if (!message) return;

    currentMessageId = id;

    // Mark as read when opening
    if (message.status === 'new') {
      await fetch(`/api/admin/messages/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ read: true })
      });
    }

    const date = new Date(message.created_at);
    const formattedDate = date.toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    document.getElementById('modal-subject')!.textContent = message.subject || 'Sin asunto';
    document.getElementById('modal-name')!.textContent = message.name;
    document.getElementById('modal-email')!.textContent = message.email;
    document.getElementById('modal-phone')!.textContent = message.phone || 'No proporcionado';
    document.getElementById('modal-type')!.textContent = message.category || 'general';
    document.getElementById('modal-message')!.textContent = message.message;
    document.getElementById('modal-date')!.textContent = formattedDate;

    document.getElementById('message-modal')!.classList.remove('hidden');

    await loadMessages();
  };

  // Delete message
  (window as any).deleteMessage = async (id: string) => {
    if (!confirm('¿Estás seguro de que quieres eliminar este mensaje?')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/messages/${id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        await loadMessages();
        alert('Mensaje eliminado correctamente');
      } else {
        alert('Error al eliminar el mensaje');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar el mensaje');
    }
  };

  // Close modal
  const closeModal = () => {
    document.getElementById('message-modal')!.classList.add('hidden');
    currentMessageId = null;
  };

  document.getElementById('close-modal')?.addEventListener('click', closeModal);
  document.getElementById('close-modal-btn')?.addEventListener('click', closeModal);

  // Delete from modal
  document.getElementById('modal-delete')?.addEventListener('click', async () => {
    if (!currentMessageId) return;

    if (!confirm('¿Estás seguro de que quieres eliminar este mensaje?')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/messages/${currentMessageId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        closeModal();
        await loadMessages();
        alert('Mensaje eliminado correctamente');
      } else {
        alert('Error al eliminar el mensaje');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar el mensaje');
    }
  });

  // Filters
  const applyFilters = () => {
    const searchTerm = (document.getElementById('search-input') as HTMLInputElement).value.toLowerCase();
    const statusFilter = (document.getElementById('filter-status') as HTMLSelectElement).value;
    const typeFilter = (document.getElementById('filter-type') as HTMLSelectElement).value;

    let filtered = allMessages;

    // Search filter
    if (searchTerm) {
      filtered = filtered.filter(message =>
        message.name.toLowerCase().includes(searchTerm) ||
        message.email.toLowerCase().includes(searchTerm) ||
        (message.subject || '').toLowerCase().includes(searchTerm) ||
        message.message.toLowerCase().includes(searchTerm)
      );
    }

    // Status filter
    if (statusFilter !== 'all') {
      filtered = filtered.filter(message =>
        statusFilter === 'unread' ? message.status === 'new' : message.status === 'read'
      );
    }

    // Type filter
    if (typeFilter !== 'all') {
      filtered = filtered.filter(message => message.category === typeFilter);
    }

    renderMessages(filtered);
  };

  document.getElementById('search-input')?.addEventListener('input', applyFilters);
  document.getElementById('filter-status')?.addEventListener('change', applyFilters);
  document.getElementById('filter-type')?.addEventListener('change', applyFilters);

  // Initialize
  checkAuth();
  loadMessages();
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
