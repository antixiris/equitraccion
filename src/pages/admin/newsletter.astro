---
// Admin Newsletter Management - Gestión de Suscriptores
import BaseLayout from '../../layouts/BaseLayout.astro';

const title = 'Gestionar Newsletter | Equitracción CMS';
---

<BaseLayout title={title} mode="hybrid">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-8">
            <nav class="flex items-center gap-6">
              <a href="/admin" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Dashboard
              </a>
              <a href="/admin/posts" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Blog
              </a>
              <a href="/admin/courses" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Cursos
              </a>
              <a href="/admin/newsletter" class="text-base font-semibold text-amber-800 border-b-2 border-amber-800 pb-1">
                Newsletter
              </a>
              <a href="/admin/messages" class="text-base text-gray-600 hover:text-amber-800 transition-colors">
                Mensajes
              </a>
            </nav>
            <div class="border-l pl-8">
              <h1 class="font-heading font-bold text-2xl text-gray-900">Gestionar Newsletter</h1>
              <p class="text-sm text-gray-600">Ver y gestionar suscriptores del boletín</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <a
              href="/api/newsletter/send?preview=true"
              target="_blank"
              class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors"
            >
              Preview Newsletter
            </a>
            <button id="logout-btn" class="text-base text-gray-600 hover:text-gray-900">
              Cerrar sesión
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
      <!-- Stats Cards -->
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-600">Total Suscriptores</h3>
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
              </svg>
            </div>
          </div>
          <p class="text-3xl font-bold text-gray-900" id="total-subscribers">0</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-600">Activos</h3>
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <p class="text-3xl font-bold text-gray-900" id="active-subscribers">0</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-600">Inactivos</h3>
            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
            </div>
          </div>
          <p class="text-3xl font-bold text-gray-900" id="inactive-subscribers">0</p>
        </div>
      </div>

      <!-- Subscribers List -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900">Lista de Suscriptores</h2>
            <div class="flex items-center gap-3">
              <input
                type="text"
                id="search-input"
                placeholder="Buscar por email..."
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))] focus:border-transparent text-sm"
              />
              <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[rgb(var(--color-brand-primary))] focus:border-transparent text-sm">
                <option value="all">Todos</option>
                <option value="active">Activos</option>
                <option value="inactive">Inactivos</option>
              </select>
            </div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Suscripción</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody id="subscribers-table" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                  Cargando suscriptores...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Info Box -->
      <div class="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-6">
        <div class="flex items-start gap-3">
          <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h3 class="font-semibold text-blue-900 mb-2">Sobre el Newsletter Automático</h3>
            <p class="text-sm text-blue-800 mb-3">
              El sistema está configurado para enviar automáticamente el newsletter el día 1 de cada mes con:
            </p>
            <ul class="text-sm text-blue-800 space-y-1 ml-4 list-disc">
              <li>Resumen de posts publicados el mes anterior</li>
              <li>Próximos cursos programados (siguientes 3 meses)</li>
              <li>Enlaces directos a los artículos y formulario de contacto</li>
            </ul>
            <p class="text-sm text-blue-800 mt-3">
              Para más información sobre la configuración del envío automático, consulta el archivo <code class="bg-blue-100 px-2 py-0.5 rounded">NEWSLETTER_SETUP.md</code>
            </p>
          </div>
        </div>
      </div>
    </main>
  </div>
</BaseLayout>

<script>
  let allSubscribers: any[] = [];

  // Check authentication
  const checkAuth = () => {
    const isAuthenticated = sessionStorage.getItem('admin_authenticated');
    if (!isAuthenticated) {
      window.location.href = '/admin/login';
    }
  };

  // Handle logout
  const logoutBtn = document.getElementById('logout-btn');
  logoutBtn?.addEventListener('click', () => {
    sessionStorage.removeItem('admin_authenticated');
    window.location.href = '/admin/login';
  });

  // Load stats and subscribers from API
  const loadStats = async () => {
    try {
      const response = await fetch('/api/newsletter/list');
      const result = await response.json();

      if (!result.success) {
        throw new Error(result.message);
      }

      const subscribers = result.data || [];
      allSubscribers = subscribers;

      const total = subscribers.length;
      const active = subscribers.filter((s: any) => s.status === 'active').length;
      const inactive = total - active;

      document.getElementById('total-subscribers')!.textContent = total.toString();
      document.getElementById('active-subscribers')!.textContent = active.toString();
      document.getElementById('inactive-subscribers')!.textContent = inactive.toString();

      // Render initial list
      renderSubscribers(subscribers);
    } catch (error) {
      console.error('Error loading stats:', error);
      const container = document.getElementById('subscribers-container');
      if (container) {
        container.innerHTML = '<div class="text-center py-12 text-red-600">Error al cargar suscriptores. Por favor, recarga la página.</div>';
      }
    }
  };

  // Load subscribers is now handled by loadStats, so this can be removed
  // Kept for backwards compatibility but delegates to loadStats
  const loadSubscribers = async () => {
    await loadStats();
  };

  // Render subscribers table
  const renderSubscribers = (subscribers: any[]) => {
    const tbody = document.getElementById('subscribers-table')!;

    if (subscribers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">No hay suscriptores</td></tr>';
      return;
    }

    tbody.innerHTML = subscribers.map(sub => {
      const statusClass = sub.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
      const statusText = sub.status === 'active' ? 'Activo' : 'Inactivo';
      const actionText = sub.status === 'active' ? 'Desactivar' : 'Activar';
      const dateStr = new Date(sub.created_at).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `<tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-gray-900">${sub.email}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
            ${statusText}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          ${dateStr}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
          <button
            class="toggle-status-btn text-blue-600 hover:text-blue-900 mr-3"
            data-id="${sub.id}"
            data-current="${sub.status}"
          >
            ${actionText}
          </button>
          <button
            class="delete-btn text-red-600 hover:text-red-900"
            data-id="${sub.id}"
            data-email="${sub.email}"
          >
            Eliminar
          </button>
        </td>
      </tr>`;
    }).join('');

    // Add event listeners
    document.querySelectorAll('.toggle-status-btn').forEach(btn => {
      btn.addEventListener('click', handleToggleStatus);
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', handleDelete);
    });
  };

  // Toggle subscriber status
  const handleToggleStatus = async (e: Event) => {
    const btn = e.target as HTMLButtonElement;
    const id = btn.dataset.id;
    const currentStatus = btn.dataset.current === 'true';

    if (!confirm(`¿Confirmar ${currentStatus ? 'desactivación' : 'activación'} del suscriptor?`)) {
      return;
    }

    try {
      const { error } = await supabase
        .from('newsletter_subscriptions')
        .update({ status: currentStatus === 'active' ? 'unsubscribed' : 'active' })
        .eq('id', id);

      if (error) throw error;

      await loadStats();
      await loadSubscribers();
    } catch (error) {
      console.error('Error toggling status:', error);
      alert('Error al actualizar el estado');
    }
  };

  // Delete subscriber
  const handleDelete = async (e: Event) => {
    const btn = e.target as HTMLButtonElement;
    const id = btn.dataset.id;
    const email = btn.dataset.email;

    if (!confirm(`¿Estás seguro de que quieres eliminar al suscriptor ${email}?`)) {
      return;
    }

    try {
      const { error } = await supabase
        .from('newsletter_subscriptions')
        .delete()
        .eq('id', id);

      if (error) throw error;

      await loadStats();
      await loadSubscribers();
    } catch (error) {
      console.error('Error deleting subscriber:', error);
      alert('Error al eliminar el suscriptor');
    }
  };

  // Search functionality
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    const filtered = allSubscribers.filter(sub =>
      sub.email.toLowerCase().includes(query)
    );
    renderSubscribers(filtered);
  });

  // Filter by status
  const filterStatus = document.getElementById('filter-status') as HTMLSelectElement;
  filterStatus?.addEventListener('change', (e) => {
    const status = (e.target as HTMLSelectElement).value;
    let filtered = allSubscribers;

    if (status === 'active') {
      filtered = allSubscribers.filter(sub => sub.status === 'active');
    } else if (status === 'inactive') {
      filtered = allSubscribers.filter(sub => sub.status !== 'active');
    }

    renderSubscribers(filtered);
  });

  // Initialize
  checkAuth();
  loadStats();
  loadSubscribers();
</script>
